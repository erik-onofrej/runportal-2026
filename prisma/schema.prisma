// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Example Model 1: User

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      String   @default("user")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Better Auth required fields
  emailVerified Boolean @default(false)
  image         String?
  password      String?

  // Relations
  blogs    Blog[]
  sessions Session[]
  accounts Account[]
}

// Blog Model (renamed from Post)

model Blog {
  id           Int            @id @default(autoincrement())
  title        String
  slug         String         @unique
  content      String         @db.Text
  excerpt      String?
  thumbnailUrl String?
  status       String         @default("draft")
  views        Int            @default(0)
  publishedAt  DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  authorId   String
  author     User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories BlogCategory[]
}

// Example Model 3: Category

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  color       String   @default("#3B82F6")
  sortOrder   Int      @default(0)
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  blogs BlogCategory[]
}

// Join table for Blog <-> Category many-to-many relation

model BlogCategory {
  blogId     Int
  categoryId Int

  blog     Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([blogId, categoryId])
  @@index([blogId])
  @@index([categoryId])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// Contact Submission Model

model ContactSubmission {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  subject   String?
  message   String   @db.Text
  status    String   @default("new")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// RUNNING EVENTS MODELS
// ============================================================================

// Geographic Reference (Slovak-specific)

model Region {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  code      String     @unique
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  districts District[]
  locations Location[]

  @@index([code])
}

model District {
  id        Int      @id @default(autoincrement())
  name      String
  code      String
  regionId  Int
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  region    Region     @relation(fields: [regionId], references: [id], onDelete: Cascade)
  locations Location[]

  @@unique([regionId, name])
  @@index([regionId])
  @@index([code])
}

// Location

model Location {
  id           Int      @id @default(autoincrement())
  name         String
  street       String?
  city         String
  postalCode   String?
  districtId   Int
  regionId     Int
  gpsLatitude  Float?
  gpsLongitude Float?
  locationNote String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  district District @relation(fields: [districtId], references: [id], onDelete: Restrict)
  region   Region   @relation(fields: [regionId], references: [id], onDelete: Restrict)
  events   Event[]

  @@index([districtId])
  @@index([regionId])
  @@index([city])
}

// Organizer

model Organizer {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?  @db.Text
  email       String?
  phone       String?
  website     String?
  logo        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  events Event[]

  @@index([name])
}

// Event (main container for one or more runs)

model Event {
  id                    Int      @id @default(autoincrement())
  title                 String
  slug                  String   @unique
  description           String?  @db.Text
  startDate             DateTime
  endDate               DateTime
  locationId            Int
  organizerId           Int
  contactEmail          String?
  contactPhone          String?
  bankAccount           String?
  paymentNote           String?  @db.Text
  coverImage            String?
  status                String   @default("draft")
  registrationOpenDate  DateTime?
  registrationCloseDate DateTime?
  maxParticipants       Int?
  longDescription       String?  @db.Text
  rules                 String?  @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  location    Location          @relation(fields: [locationId], references: [id], onDelete: Restrict)
  organizer   Organizer         @relation(fields: [organizerId], references: [id], onDelete: Restrict)
  runs        Run[]
  schedule    EventSchedule[]
  partners    EventPartner[]
  attachments EventAttachment[]

  @@index([slug])
  @@index([status])
  @@index([startDate])
  @@index([locationId])
  @@index([organizerId])
}

// Run (individual race within an event)

model Run {
  id              Int      @id @default(autoincrement())
  eventId         Int
  name            String
  distance        Float
  elevationGain   Int?
  surface         String?
  startTime       DateTime
  maxParticipants Int?
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  event         Event                   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  categories    RunCategoryAssignment[]
  entryFees     RunEntryFee[]
  registrations Registration[]
  results       RunResult[]

  @@index([eventId])
  @@index([startTime])
}

// RunCategory (age/gender groups)

model RunCategory {
  id        Int      @id @default(autoincrement())
  name      String
  code      String   @unique
  minAge    Int?
  maxAge    Int?
  gender    String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runs          RunCategoryAssignment[]
  registrations Registration[]

  @@index([code])
}

// Join table for Run <-> RunCategory many-to-many relation

model RunCategoryAssignment {
  runId      Int
  categoryId Int

  run      Run         @relation(fields: [runId], references: [id], onDelete: Cascade)
  category RunCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([runId, categoryId])
  @@index([runId])
  @@index([categoryId])
}

// RunEntryFee (pricing by date)

model RunEntryFee {
  id        Int      @id @default(autoincrement())
  runId     Int
  name      String
  amount    Float
  currency  String   @default("EUR")
  validFrom DateTime
  validTo   DateTime
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([validFrom, validTo])
}

// EventSchedule

model EventSchedule {
  id          Int       @id @default(autoincrement())
  eventId     Int
  title       String
  description String?   @db.Text
  startTime   DateTime
  endTime     DateTime?
  location    String?
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([startTime])
}

// Partner

model Partner {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  logo        String?
  website     String?
  description String?  @db.Text
  type        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  events EventPartner[]

  @@index([name])
}

// EventPartner (many-to-many join table)

model EventPartner {
  eventId   Int
  partnerId Int
  level     String? @default("general")
  sortOrder Int     @default(0)

  event   Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@id([eventId, partnerId])
  @@index([eventId])
  @@index([partnerId])
}

// EventAttachment

model EventAttachment {
  id          Int      @id @default(autoincrement())
  eventId     Int
  title       String
  fileUrl     String
  fileType    String?
  fileSize    Int?
  description String?  @db.Text
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

// Registration (sign-ups for runs)

model Registration {
  id                 Int      @id @default(autoincrement())
  runId              Int
  categoryId         Int
  firstName          String
  lastName           String
  email              String
  phone              String?
  dateOfBirth        DateTime
  gender             String
  city               String?
  club               String?
  registrationNumber String   @unique
  registeredAt       DateTime @default(now())
  paid               Boolean  @default(false)
  paidAmount         Float?
  paidAt             DateTime?
  paymentNote        String?
  presented          Boolean  @default(false)
  bibNumber          String?
  status             String   @default("pending")
  notes              String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  run      Run         @relation(fields: [runId], references: [id], onDelete: Cascade)
  category RunCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  @@index([runId])
  @@index([categoryId])
  @@index([email])
  @@index([registrationNumber])
  @@index([status])
}

// RunResult (race outcomes)

model RunResult {
  id            Int      @id @default(autoincrement())
  runId         Int
  firstName     String
  lastName      String
  yearOfBirth   Int
  club          String?
  bibNumber     String?
  category      String
  overallPlace  Int?
  categoryPlace Int?
  finishTime    Int?
  gunTime       Int?
  resultStatus  String   @default("finished")
  pace          Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([overallPlace])
  @@index([resultStatus])
}
